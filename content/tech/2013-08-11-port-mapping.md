---
title: 网络：从外网访问局域网内主机(端口映射) z
date: 2013-08-11
categories: ["4-计算机 - 网络"]
tags: ["4-端口映射", "4-内网", "4-外网"]
slug: port-mapping
---

首先要做的事情如下：

1. 确认你内网的路由器是否支持端口映射功能
2. 如果你的路由器支持端口映射功能，在你本机安装远程控制软件
3. 远程控制软件安装后，设置路由器，输入远程控制软件的端口和你本机ip，做端口映射
4. 在你本机安装花生壳之类的动态域名软件
5. 测试成功后，你在外网打开远程软件控制端，输入动态域名就可以访问你自己电脑了

<!-- more -->

# 端口映射（Port Mapping）

如果你是 ADSL、MODEM 或光纤等宽带接入用户，想在公司或单位内部建一个服务器或 WEB 站点，并且想让互联网上的用户访问你的服务器，那么你就会遇到端口映射问题。
通常情况下，路由器都有防火墙功能，互联网用户只能访问到你的路由器WAN口(接 ADSL 的电话线口或路由宽带外网口)，而访问不到内部服务器。要想让互联网用户访问到你建的服务器，就要在路由器上做一个转发设置，也就是端口映射设置，让互联网用户发送的请求到达路由器后,再转发到你建立的服务器或 WEB 站点。这就是端口映射。由于各个路由器厂商所取功能名称不一样，有的叫虚拟服务器，有的叫NAT设置(BitComet 中常见问题)端口映射。
其实做端口映射设置很简单，例如要映射一台内网 IP 地址为 192.168.0.66 的WEB服务器，只需把WEB服务器的 IP 地址 192.168.0.66 和 TCP 端口 80 填入到路由器的端口映射表中就OK了。

关于打开端口映射后的安全问题：设置了端口映射后，互联网用户能够通过设置好映射的端口，跳过路由器防火墙访问到你的服务器，在通过攻击你服务器上的漏洞控制你的主机，所以打开端口映射后有必要在你的服务器上再挂一个防火墙也确保安全性。

**花生壳**是一套完全免费的动态域名解析服务客户端软件。当您安装并注册该项服务，无论您在任何地点、任何时间、使用任何线路，均可利用这一服务建立拥有固定域名和最大自主权的互联网主机。“花生壳”支持的线路包括普通电话线、ISDN、ADSL、有线电视网络、双绞线到户的宽带网和其它任何能够提供互联网真实IP的接入服务线路，而无论连接获得的 IP 属于动态还是静态。

# 动态域名

用户每次上网得到新的动态分配的 IP 地址之后，安装在用户计算机里的动态域名软件就会把这个IP地址发送到动态域名解析服务器，更新域名解析数据库。Internet 上的其他人要访问这个域名的时候，动态域名解析服务器会返回正确的IP地址给他。这叫动态域名。

因为绝大部分 Internet 用户上网的时候分配到的 IP 地址都是动态的，用传统的静态域名解析方法，用户想把自己上网的计算机做成一个有固定域名的网站，是不可能的。而有了动态域名，这个美梦就可以成真。用户可以申请一个域名，利用动态域名解析服务，把域名与自己上网的计算机绑定在一起，这样就可以在家里或公司里搭建自己的网站，非常方便。

端口映射（Port Mapping/Port Forwarding）有点类似服务重定向, 所以有些路由器(Router)中也称为虚拟服务器(Virtual Server)。为了描述方便，下面的叙述中统一称为[端口映射]。

采用端口映射的方法，可以实现从 Internet 到局域网内部机器的特定端口服务的访问。

端口映射的实现方式可以分为纯软件和软硬结合方式。以纯软件方式实现端口映射功能软件有很多, 比如, MS Windows9x/200/XP 下的 PortTunnel 专门针对 HTTP、FTP、SMTP 服务的端口映射，提供了较多的参数设置，在相应的标签菜单下调整。又如各种版本的Linux 操作系统本身就支持端口映射，只需要网络管理员做相应的设置和调整即可实现。而以软硬结合方式实现端口映射功能的，主要常见于各种路由器(提供网关路由功能) 。

# 各种路由器(Router)中如何实现端口映射

一般路由器中有个端口映射（Port Mapping）或者虚拟服务器(Virtual Server)的设置。用户需要在路由器(Router)的“管理界面”中相应的端口映射界面中, 设置好相应的需要映射的端口, 协议,内网地址等, 才能生效。设置的方法可能会因为路由器(Router)不同的品牌和型号，在设置的方法上也会有所不同。端口映射支持的网络协议有TCP/UDP/两者, 所以进行端口映射设置时, 如果不熟悉, 可以选择两者都支持。

## 举例说明

以某路由器(Router)为例，在启用其路由功能之后，网络拓扑图如下：

这里假定路由器(Router)默认 IP 内网地址为 192.168.1.1，内网中电脑一般可以设置成为 192.168.1.X（X=2~254），在内网中某一台电脑上打开 IE，在地址栏输入 http://192.168.1.1，输入初始用户名、密码，之后就可以看到设置界面了。

针对邮件服务器要做如下设置：进入“端口映射”，在端口填入 25, 协议中选择： TCP, IP 地址： 192.168.1.x (x 为安装邮件服务器电脑的局域网IP 地址），同样方法设置 110(pop3),6080(webmail) 端口等。 以上假定用户内网段地址为: 192.168.1.0。设置好后, 就实现了端口映射功能了, 发往路由器的邮件就会自动转发到指定的内网主机上 (192.168.1.x)。

同样, 如果想设置特殊端口, 比如: `6000`。 在端口填入`6000`, 协议中选择： `ALL`(或根据具体情况选择), IP 地址：192.168.1.x(x 为内网段地址`1~254`)。

设置好后, 发往路由器 6000 端口的任何数据就会自动转发到主机 192.168.1.x 的端口 6000 上了。

以上说明没有针对具体路由器。 具体情况, 请查阅您的路由器说明书，看看如何作端口映射。

<hr />

参考：
1. <http://www.hrtl.com.cn/News_398.aspx>
2. <https://my.oschina.net/eicyan/blog/209440>